@{
    ViewData["Title"] = "Chatbox AI với Grok";
}

<h1>Chatbox AI với Grok</h1>
<div id="chatbox" style="width: 500px; height: 400px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px;"></div>
<input type="text" id="userInput" placeholder="Nhập tin nhắn..." style="width: 400px; padding: 5px; margin-top: 10px;">
<button id="sendButton" style="padding: 5px 10px;">Gửi</button>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .withAutomaticReconnect()
            .build();

        connection.on("ReceiveMessage", (user, message) => {
            const chatbox = document.getElementById("chatbox");
            const div = document.createElement("div");
            div.innerHTML = `<b>${user}:</b> ${message}`;
            chatbox.appendChild(div);
            chatbox.scrollTop = chatbox.scrollHeight;
        });

        connection.start().then(() => {
            console.log("SignalR Connected");
        }).catch(err => {
            console.error("SignalR Connection Error:", err);
        });

        async function sendMessage() {
            const userInput = document.getElementById("userInput").value;
            if (!userInput) return;

            try {
                await connection.invoke("SendMessage", "You", userInput);
                document.getElementById("userInput").value = "";
            } catch (err) {
                console.error("Send Message Error:", err);
                const chatbox = document.getElementById("chatbox");
                chatbox.innerHTML += `<div><b>System:</b> Lỗi khi gửi tin nhắn, vui lòng thử lại.</div>`;
            }
        }

        document.getElementById("sendButton").addEventListener("click", sendMessage);
        document.getElementById("userInput").addEventListener("keypress", function (e) {
            if (e.key === "Enter") sendMessage();
        });
    </script>
}